"0","knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)"
"0","library(tidyverse)"
"0","library(tidyr)"
"0","library(lubridate)  "
"0","library(readxl)      "
"0","library(janitor)"
"0","library(scales)"
"0","library(tidycensus)"
"0","library(sf)"
"0","#install.packages(""ggrepel"")"
"0","library(ggrepel)"
"0",""
"0","source(""CENSUS-setup.R"")"
"0","Sys.getenv(""CENSUS_API_KEY"")"
"1","[1]"
"1"," ""40b3c2280a3fa3cf4c4ae11a8b87fe3230b37de1"""
"1","
"
"0","# ---- Load data ----"
"0","nyt_mc     <- read_csv(""migrantchildren.csv"") %>% clean_names()"
"0","mc_pop     <- read_csv(""mc_w_pop.csv"") %>% clean_names()"
"0","zips_cross <- read_excel(""zips_crosswalk.xlsx"") %>% clean_names()"
"0",""
"0","# ---- Virginia working table, with parsed dates ----"
"0","nyt_mc_va <- nyt_mc %>%"
"0","  left_join(zips_cross, by = c(""sponsor_zipcode"" = ""zip"")) %>%"
"0","  filter(state == ""Virginia"") %>%"
"0","  mutate(date = as.Date(childs_date_of_release, format = ""%m/%d/%y""))"
"0",""
"0","# ---- ACS county population (better denominators ----"
"0","va_acs_pop <- get_acs("
"0","  geography = ""county"", state = ""VA"", variables = ""B01003_001"","
"0","  year = 2022, survey = ""acs5"", cache_table = TRUE"
"0",") %>%"
"0","  clean_names() %>%"
"0","  rename(population = estimate) %>%"
"0","  mutate("
"0","    county_name_acs  = str_remove(name, "", Virginia""),"
"0","    county_clean_acs = county_name_acs |> str_remove(""\\s*County$"") |> stringr::str_to_lower()"
"0","  ) %>%"
"0","  select(geoid, county_clean_acs, population)"
"0",""
"0","# ---- ZIP -> ONE county (prevents multi-county duplication) ----"
"0","zips_va_unique <- zips_cross %>%"
"0","  filter(state == ""Virginia"") %>%"
"0","  arrange(zip, county) %>%                 # deterministic tie-break"
"0","  group_by(zip) %>% slice(1) %>% ungroup() %>%"
"0","  transmute("
"0","    zip = as.character(zip),"
"0","    county_clean = county |> str_remove(""\\s*County$"") |> stringr::str_to_lower()"
"0","  )"
"0",""
"0","# ---- Count placements per ZIP (all years), then roll up to county via the one-to-one ZIP->county ----"
"0","va_county_counts <- nyt_mc %>%"
"0","  clean_names() %>%"
"0","  count(sponsor_zipcode, name = ""placements_zip"") %>%"
"0","  rename(zip = sponsor_zipcode) %>%"
"0","  mutate(zip = as.character(zip)) %>%"
"0","  inner_join(zips_va_unique, by = ""zip"") %>%"
"0","  group_by(county_clean) %>%"
"0","  summarise(placements = sum(placements_zip), .groups = ""drop"")"
"0",""
"0","# ---- Join ACS denominators and compute rate per 10k ----"
"0","va_rates_acs <- va_county_counts %>%"
"0","  inner_join(va_acs_pop, by = c(""county_clean"" = ""county_clean_acs"")) %>%"
"0","  mutate(rate_per_10k = (placements / population) * 10000)"
"0",""
"0","# Top 10s weâ€™ll use for A and A2"
"0","va_top10_rate_acs   <- va_rates_acs %>% filter(placements >= 20) %>% arrange(desc(rate_per_10k)) %>% slice_head(n = 10)"
"0","va_top10_counts_acs <- va_rates_acs %>% arrange(desc(placements)) %>% slice_head(n = 10)"
"0",""
"0","# ---- Brand color ----"
"0","brand_blue <- ""#79a1d8"""
